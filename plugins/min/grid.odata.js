(function(e){String.prototype.format=function(){var e=arguments;return this.replace(/\{\{|\}\}|\{(\d+)\}/g,function(g,h){return"{{"===g?"{":"}}"===g?"}":e[h]})};e.jgrid.odataHelper={resolveJsonReferences:function(e,g){function h(a,e,y){if("object"!==typeof a||!a)return a;if("[object Array]"===Object.prototype.toString.call(a)){for(f=0;f<a.length;f++){if("object"!==typeof a[f]||!a[f])return a[f];a[f]=a[f].$ref?h(a[f],f,a):h(a[f],e,a)}return a}if(a.$ref){d=a.$ref;if(c[d])return c[d];g.push([y,e,d])}else{if(a.$id){e=
a.$id;delete a.$id;if(a.$values)a=a.$values.map(h);else for(var b in a)a.hasOwnProperty(b)&&(a[b]=h(a[b],b,a));c[e]=a}return a}}var f,d,c={};g=g||[];"string"===typeof e&&(e=JSON.parse(e));e=h(e);for(f=0;f<g.length;f++)d=g[f],d[0][d[1]]=c[d[2]];return e},convertXmlToJson:function(k){var g={},h,f,d,c;if(1===k.nodeType){if(0<k.attributes.length)for(g["@attributes"]={},h=0;h<k.attributes.length;h++)f=k.attributes.item(h),g["@attributes"][f.nodeName]=f.nodeValue}else 3===k.nodeType?g=k.nodeValue:k.nodeType||
(g=k);if(k.hasChildNodes&&k.hasChildNodes())for(h=0;h<k.childNodes.length;h++){f=k.childNodes.item(h);if(3===f.nodeType)return f.nodeValue;d=f.nodeName;void 0===g[d]?g[d]=e.jgrid.odataHelper.convertXmlToJson(f):(void 0===g[d].push&&(c=g[d],g[d]=[],g[d].push(c)),g[d].push(e.jgrid.odataHelper.convertXmlToJson(f)))}return e.isEmptyObject(g)?null:g}};e.jgrid.cmTemplate.odataComplexType={editable:!1,formatter:function(k,g,h){k=h.innerHTML?e(this.p.xmlReader.id,h).html():h[this.p.jsonReader.id];return'<a href="{0}({1})/{2}" target="_self" data-id="{1}">{2}</a>'.format(this.p.url,
k,g.colModel.name)}};e.jgrid.cmTemplate.odataNavigationProperty={editable:!1,formatter:function(k,g,h){k=h.innerHTML?e(this.p.xmlReader.id,h).html():h[this.p.jsonReader.id];return'<a href="{0}({1})/{2}" target="_self" data-id="{1}">{2}</a>'.format(this.p.url,k,g.colModel.name)}};e.jgrid.extend({odataInit:function(k){function g(d,c,a,u){var f,b;if(c&&(a||"nu"===u||"nn"===u)){if(a)for(f=0;f<d.colModel.length;f++)if(b=d.colModel[f],b.name===c){if(!1===b.odata||b.odataunformat&&(c=e.isFunction(b.odataunformat)?
b.odataunformat(c,a,u):b.odataunformat,!c))return;b.searchrules&&(b.searchrules.integer||b.searchrules.number||b.searchrules.date)?b.searchrules&&b.searchrules.date&&(a=(new Date(a)).toISOString()):a="'"+a+"'";break}switch(u){case "in":case "cn":return"indexof("+c+",tolower("+a+")) gt -1";case "ni":case "nc":return"indexof("+c+",tolower("+a+")) eq -1";case "bw":return"startswith("+c+","+a+") eq true";case "bn":return"startswith("+c+","+a+") eq false";case "ew":return"endswith("+c+","+a+") eq true";
case "en":return"endswith("+c+","+a+") eq false";case "nu":return c+" eq null";case "nn":return c+" ne null";default:return c+" "+u+" "+a}}}function h(d,c){var a,e,f="";if(d.groups&&d.groups.length){for(a=0;a<d.groups.length;a++)f+="("+h(d.groups[a],c)+")",a<d.groups.length-1&&(f+=" "+d.groupOp.toLowerCase()+" ");d.rules&&d.rules.length&&(f+=" "+d.groupOp.toLowerCase()+" ")}if(d.rules.length)for(a=0;a<d.rules.length;a++)e=d.rules[a],(e=g(c,e.field,e.data,e.op))&&(f+=e+" "+d.groupOp.toLowerCase()+
" ");return f=f.trim().replace(/\s(and|or)$/,"").trim()}function f(d,c){var a={datatype:c.datatype,jsonpCallback:c.callback};e.extend(d,{serializeGridData:function(b){var a=b;b={$top:a.rows,$skip:(parseInt(a.page,10)-1)*d.rowNum};"jsonp"===c.datatype&&(b.$callback=c.callback);c.count&&(b.$count=!0);c.inlinecount&&(b.$inlinecount="allpages");a.sidx&&(b.$orderby=a.sidx+" "+a.sord);a._search&&(a.filters?(a=e.parseJSON(a.filters),a=h(a,d),0<a.length&&(b.$filter=a)):b.$filter=g(d,a.searchField,a.searchString,
a.searchOper));return this.p.odataPostData=b},ajaxGridOptions:a,mtype:"GET",url:c.odataurl},a);a={contentType:"application/"+("jsonp"===c.datatype?"json":c.datatype)+";charset=utf-8",datatype:"jsonp"===c.datatype?"json":c.datatype};d.inlineEditing=e.extend(!0,{beforeSaveRow:function(b,a,d){"edit"===b.extraparam.oper?(b.url=c.odataurl,b.mtype=c.odataverbs.inlineEditingEdit,b.url+="("+a+")"):(b.url=c.odataurl,b.mtype=c.odataverbs.inlineEditingAdd);return!0},serializeSaveData:function(b){return JSON.stringify(b)},
ajaxSaveOptions:a},d.inlineEditing||{});e.extend(d.formEditing,{onclickSubmit:function(b,a,e){"add"===e?(b.url=c.odataurl,b.mtype=c.odataverbs.formEditingAdd):"edit"===e&&(b.url=c.odataurl+"("+a[d.id+"_id"]+")",b.mtype=c.odataverbs.formEditingEdit);return a},ajaxEditOptions:a,serializeEditData:function(b){return JSON.stringify(b)}});e.extend(d.formDeleting,{url:c.odataurl,mtype:"DELETE",serializeDelData:function(b){return""},onclickSubmit:function(b,a){b.url+="("+a+")";return""},ajaxDelOptions:a});
a=(a=d.colModel.filter(function(b){return!!b.key})[0])?a.name:"id";if("xml"===c.datatype){c.annotations&&e.extend(!0,d,{loadBeforeSend:function(b){b.setRequestHeader("Prefer",'odata.include-annotations="*"')}});var f=c.useXmlSerializer?"feed":"ArrayOf"+c.entityType,k=c.useXmlSerializer?"entry":c.entityType;e.extend(!0,d,{xmlReader:{root:f,row:k,records:function(b){return e(f+" "+k,b).length},page:function(b){return Math.ceil((d.odataPostData.$skip+d.rowNum)/d.rowNum)},total:function(b){b=e(f+" "+
k,b).length;return Math.ceil((d.odataPostData.$skip+d.rowNum)/d.rowNum)+(0<b?1:0)},repeatitems:!1,userdata:c.useXmlSerializer?"userdata":"ArrayOfUserData UserData",id:a}})}else c.annotations?e.extend(!0,d,{loadBeforeSend:function(b){b.setRequestHeader("Prefer",'odata.include-annotations="*"')},jsonReader:{root:"value",repeatitems:!1,records:function(b){return b[c.annotationName].records},page:function(b){return b[c.annotationName].page},total:function(b){return b[c.annotationName].total},userdata:function(b){return b[c.annotationName].userdata},
id:a}}):e.extend(!0,d,{jsonReader:{root:"value",repeatitems:!1,records:function(b){return b["odata.count"]||b["@odata.count"]},page:function(b){var a;b["odata.nextLink"]?a=parseInt(b["odata.nextLink"].split("skip=")[1],10):(a=d.odataPostData.$skip+d.rowNum,b=b["odata.count"]||b["@odata.count"],a>b&&(a=b));return Math.ceil(a/d.rowNum)},total:function(b){return Math.ceil(parseInt(b["odata.count"]||b["@odata.count"],10)/d.rowNum)},userdata:"userdata",id:a}})}return this.each(function(){var d=this,c=
e(d),a=d.p;if(d.grid&&a){var g=e.extend(!0,{gencolumns:!1,odataurl:a.url,datatype:"json",entityType:null,annotations:!1,annotationName:"@jqgrid.GridModelAnnotate",useXmlSerializer:!0,odataverbs:{inlineEditingAdd:"POST",inlineEditingEdit:"PATCH",formEditingAdd:"POST",formEditingEdit:"PUT"}},k||{});"jsonp"===g.datatype&&(g.callback="jsonpCallback");if(g.entityType){g=!g.version||4>g.version?e.extend(!0,{inlinecount:!0,count:!1},g||{}):e.extend(!0,{inlinecount:!1,count:!0},g||{});if(g.gencolumns){var h=
e.extend(!0,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,async:!1,entityType:null,metadatatype:k.datatype||"xml",metadataurl:(k.odataurl||a.url)+"/$metadata"},k||{});h.async&&(h.successfunc=function(){d.grid.hDiv&&(d.grid.hDiv.loading=!1);c.trigger("reloadGrid")},d.grid.hDiv&&(d.grid.hDiv.loading=!0));c.jqGrid("odataGenColModel",h)}f(a,g)}else e.isFunction(g.errorfunc)&&g.errorfunc({},"entityType cannot be empty",0)}})},odataGenColModel:function(k){function g(a,c){var d=
[],b,f,g,h,k,q,n,l={};k=e("Schema",a).attr("Namespace")+".";b=e('EntityType[Name="'+c+'"]',a).find("Property,NavigationProperty");g=(f=e('EntityType[Name="'+c+'"] Key PropertyRef',a))&&0<f.length?f.first().attr("Name"):"";b&&b.each(function(b,a){e.each(a.attributes,function(){l[this.name]=this.value});h=l.Name===g;q="Property"===a.tagName&&!!k&&0<=l.Type.indexOf(k);n="NavigationProperty"===a.tagName;d.push(e.extend({iskey:h,isComplex:q,isNavigation:n},l))});return d}var h=this[0],f=h.p,d=e(h),c=e.extend(!0,
{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,entityType:null,metadataurl:f.url+"/$metadata",metadatatype:"xml",async:!1},k||{});"jsonp"===c.metadatatype&&(c.callback="jsonpCallback");c.entityType?e.ajax({url:c.metadataurl,type:"GET",dataType:c.metadatatype,jsonpCallback:c.callback,async:c.async,cache:!1}).done(function(a,h,k){var b=0,m=0,p,t,r,q;"xml"!==c.metadatatype&&(a=e.jgrid.odataHelper.resolveJsonReferences(a));var n=d.triggerHandler("jqGridODataParseMetadata",a);
void 0===n&&e.isFunction(c.parsemetadatafunc)&&(n=c.parsemetadatafunc(a,h,k));if(void 0===n){if("xml"===c.metadatatype)p=g(a,c.entityType);else{q=a;for(var l=c.entityType,b=[],v,w,x,m=0;m<q.SchemaElements.length;m++)if(q.SchemaElements[m].Name===l){p=q.SchemaElements[m].DeclaredProperties;q.SchemaElements[m].NavigationProperties&&(p=p.concat(q.SchemaElements[m].NavigationProperties));r=q.SchemaElements[m].DeclaredKey;t=q.SchemaElements[m].Namespace;break}r=r&&0<r.length?r[0].Name:"";if(p)for(m=0;m<
p.length;m++)q=p[m].Name,w=q===r,v=p[m].Type.IsNullable,l=p[m].Type.Definition.Namespace+"."+p[m].Type.Definition.Name,x=!!t&&0<=l.indexOf(t),b.push({Name:q,Type:l,Nullable:v,iskey:w,isComplex:x,isNavigation:!1});p=b}l=p;if(0===l.length)e.isFunction(c.errorfunc)&&c.errorfunc({data:a,status:h,xhr:k},"parse $metadata error",0);else if(n=d.triggerHandler("jqGridODataParseColumns",l),void 0===n&&e.isFunction(c.parsecolfunc)&&(n=c.parsecolfunc(l)),void 0===n)for(n=[],b=0;b<l.length;b++)p=0<="Edm.Int16,Edm.Int32,Edm.Int64".indexOf(l[b].Type),
t=0<="Edm.Decimal,Edm.Double,Edm.Single".indexOf(l[b].Type),r=0<="Edm.Byte,Edm.SByte".indexOf(l[b].Type),m=l[b].Type&&0<=l[b].Type.indexOf("Edm.")&&(0<=l[b].Type.indexOf("Date")||0<=l[b].Type.indexOf("Time")),q=p?"integerStr":t?"numberStr":r?"booleanCheckbox":l[b].isComplex?"odataComplexType":l[b].isNavigation?"odataNavigationProperty":"text",n.push(e.extend({label:l[b].Name,name:l[b].Name,index:l[b].Name,editable:!l[b].isNavigation&&!l[b].iskey,searchrules:{integer:p,number:t,date:m,required:!l[b].Nullable||
"false"===l[b].Nullable},editrules:this.searchrules,searchtype:p?"integer":t?"number":m?"datetime":r?"checkbox":"text",inputtype:this.searchtype,edittype:this.searchtype,key:l[b].iskey},e.jgrid.cmTemplate[q]))}if(n){for(b=0;b<f.colModel.length;b++)for(m=0;m<n.length;m++)if(n[m].name===f.colModel[b].name){e.extend(!0,n[m],f.colModel[b]);f.colModel[b].searchrules&&(n[m].searchrules=f.colModel[b].searchrules);f.colModel[b].editrules&&(n[m].editrules=f.colModel[b].editrules);break}f.colModel=n;e.isFunction(c.successfunc)&&
c.successfunc()}else e.isFunction(c.errorfunc)&&c.errorfunc({data:a,status:h,xhr:k},"parse $metadata error",0)}).fail(function(a,d,f){e.isFunction(c.errorfunc)&&c.errorfunc(a,d,f)}):e.isFunction(c.errorfunc)&&c.errorfunc({},"entityType cannot be empty",0)}})})(jQuery);
